<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="author" content="Bootstrap-ecommerce by Vosidiy">
    <title>Squanchy POS</title>
    <link rel="shortcut icon" type="image/x-icon" href="/images/logos/squanchy.jpg">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/logos/squanchy.jpg">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/logos/squanchy.jpg">
    <!-- jQuery -->
    <!-- Bootstrap4 files-->
    <link href="/css/bootstrap.css" rel="stylesheet" type="text/css"/>
    <link href="/css/ui.css" rel="stylesheet" type="text/css"/>
    <link href="/fonts/fontawesome/css/fontawesome-all.min.css" type="text/css" rel="stylesheet">
    <link href="/css/OverlayScrollbars.css" type="text/css" rel="stylesheet"/>
    <!-- Font awesome 5 -->
    <style>
        .avatar {
            vertical-align: middle;
            width: 35px;
            height: 35px;
            border-radius: 50%;
        }

        .bg-default,
        .btn-default {
            background-color: #f2f3f8;
        }

        .btn-error {
            color: #ef5f5f;
        }
    </style>
    <!-- custom style -->
</head>

<body>
<section class="header-main">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-3">
                <div class="brand-wrap">
                    <img class="logo" src="/images/logos/squanchy.jpg">
                    <h2 class="logo-text">Squanchy POS</h2>
                </div> <!-- brand-wrap.// -->
            </div>
            <div class="col-lg-6 col-sm-6">
                <form action="#" class="search-wrap">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search">
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="submit">
                                <i class="fa fa-search"></i>
                            </button>
                        </div>
                    </div>
                </form> <!-- search-wrap .end// -->
            </div> <!-- col.// -->
            <div class="col-lg-3 col-sm-6">
                <div class="widgets-wrap d-flex justify-content-end">
                    <div class="widget-header">
                        <a href="#" class="icontext">
                            <a href="#" class="btn btn-primary m-btn m-btn--icon m-btn--icon-only">
                                <i class="fa fa-home"></i>
                            </a>
                        </a>
                    </div> <!-- widget .// -->
                    <div class="widget-header dropdown">
                        <a href="#" class="ml-3 icontext" data-toggle="dropdown" data-offset="20,10">
                            <img src="/images/avatars/kekwy.jpg" class="avatar" alt="">
                        </a>
                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" id="logout-btn-id"><i class="fa fa-sign-out-alt"></i> Logout</a>
                        </div> <!--  dropdown-menu .// -->
                    </div> <!-- widget  dropdown.// -->
                </div> <!-- widgets-wrap.// -->
            </div> <!-- col.// -->
        </div> <!-- row.// -->
    </div> <!-- container.// -->
</section>
<!-- ========================= SECTION CONTENT ========================= -->
<section class="section-content padding-y-sm bg-default ">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8 card padding-y-sm card ">
                <ul class="nav bg radius nav-pills nav-fill mb-3 bg" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active show" data-toggle="pill" href="#nav-tab-card">
                            <i class="fa fa-tags"></i> All</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="pill" href="#nav-tab-paypal">
                            <i class="fa fa-tags "></i> Category 1</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="pill" href="#nav-tab-bank">
                            <i class="fa fa-tags "></i> Category 2</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="pill" href="#nav-tab-bank">
                            <i class="fa fa-tags "></i> Category 3</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="pill" href="#nav-tab-bank">
                            <i class="fa fa-tags "></i> Category 4</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="pill" href="#nav-tab-bank">
                            <i class="fa fa-tags "></i> Category 5</a>
                    </li>
                </ul>
                <span id="items">
                        <div id="itemrow" class="row">

                        </div>
                    </span>
            </div>
            <div class="col-md-4">
                <div class="card">
                        <span id="cart">
                            <table class="table table-hover shopping-cart-wrap">
                                <thead class="text-muted">
                                    <tr>
                                        <th scope="col">Item</th>
                                        <th scope="col" width="120">Qty</th>
                                        <th scope="col" width="120">Price</th>
                                        <th scope="col" class="text-right" width="200">Delete</th>
                                    </tr>
                                </thead>
                                <tbody id="cart-list">

                                </tbody>
                            </table>
                        </span>
                </div> <!-- card.// -->
                <div class="box">
                    <dl class="dlist-align">
                        <dt>Tax:</dt>
                        <dd class="text-right">12%</dd>
                    </dl>
                    <dl class="dlist-align">
                        <dt>Discount:</dt>
                        <dd class="text-right"><a href="#">0%</a></dd>
                    </dl>
                    <dl class="dlist-align">
                        <dt>Sub Total:</dt>
                        <dd class="text-right">$215</dd>
                    </dl>
                    <dl class="dlist-align">
                        <dt>Total:</dt>
                        <dd class="text-right h4 b" id="total"> </dd>
                    </dl>
                    <div class="row">
                        <div class="col-md-6">
                            <button id="clean-btn"
                                    onclick="cleanCart()"
                                    class="btn  btn-default btn-error btn-lg btn-block"><i
                                    class="fa fa-times-circle "></i> Cancel </button>
                        </div>
                        <div class="col-md-6">
                            <button id="checkout-btn"
                                    class="btn  btn-primary btn-lg btn-block"><i
                                    class="fa fa-shopping-bag" ></i>
                                Charge
                            </button>
                        </div>
                    </div>
                </div> <!-- box.// -->
            </div>
        </div>
    </div><!-- container //  -->
</section>
<!-- ========================= SECTION CONTENT END// ========================= -->
<script src="/js/jquery-2.0.0.min.js" type="text/javascript"></script>
<script src="/js/bootstrap.bundle.min.js" type="text/javascript"></script>
<script src="/js/OverlayScrollbars.js" type="text/javascript"></script>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>

    axios.interceptors.request.use(config => {
        // 如果存在 token，请求携带这个 token
        if (window.sessionStorage.getItem('tokenStr')) {
            config.headers['Authorization'] = window.sessionStorage.getItem('tokenStr');
        }
        return config;
    }, error => {
        console.log(error);
    })


</script>


<script>

    // 添加商品到购物车
    function addToCart(product_id) {

        let cart = JSON.parse(localStorage.getItem('cart')) || [];

        let pid = product_id.substr(7);

        // 查找购物车中是否已存在该商品
        let existingItem = cart.find(x => x.pid === pid);

        if (existingItem) {
            // 如果已存在，则增加数量
            existingItem.amount += 1;
            renderCart(cart);
        } else {
            // 否则，将商品添加到购物车
            getRequest("http://localhost:8080/api/product", {pid: pid}).then(resp => {
                if (resp.data.code === 0) {
                    const product = resp.data.obj;
                    cart.push({pid: product.id, name: product.name, price: product.price, amount: 1});
                    renderCart(cart);
                } else {
                    alert('未知错误');
                }
            });
        }
    }

    // 获取购物车数据并渲染到页面上
    function renderCart(cart) {
        // 更新本地存储中的购物车数据
        localStorage.setItem('cart', JSON.stringify(cart));

        var total = 0;

        let $cartList = $('#cart-list');
        $cartList.empty();
        cart.forEach(item => {
            $cartList.append(CartItem(item));
            total += item.price * item.amount;
        });

        $('#total').text('$' + total.toFixed(2));
    }

    // 从购物车中删除一个某种商品
    function removeFromCart(product_id) {
        let cart = JSON.parse(localStorage.getItem('cart')) || [];

        let pid = product_id.substr(7);

        // 查找购物车中的商品
        let index = cart.findIndex(x => x.pid === pid);

        if (index !== -1) {
            let existingItem = cart.at(index);
            // 如果找到，则使其数量减一
            existingItem.amount -= 1;
            // 若其数量为 0，则移除
            if (existingItem.amount === 0) {
                cart.splice(index, 1);
            }
        }
        renderCart(cart);
    }

    // 从购物车中删除全部的某种商品
    function removeAllFromCart(product_id) {

        let cart = JSON.parse(localStorage.getItem('cart')) || [];

        let pid = product_id.substr(7);

        // 查找购物车中的商品
        let index = cart.findIndex(x => x.pid === pid);

        if (index !== -1) {
            // 如果找到，则从购物车中删除
            cart.splice(index, 1);
        }

        renderCart(cart);
    }

    function cleanCart() {
        renderCart([]);
    }

    const CartItem = ({pid, name, amount, price}) => `
        <tr>
            <td>
                <figure class="media">
                    <div class="img-wrap"><img src="/images/placeholder.png"
                                               class="img-thumbnail img-xs" alt=""></div>
                    <figcaption class="media-body">
                        <h6 class="title text-truncate"> ${name} </h6>
                    </figcaption>
                </figure>
            </td>
            <td class="text-center">
                <div class="m-btn-group m-btn-group--pill btn-group mr-2" role="group"
                     aria-label="...">
                    <button id="product${pid}" onclick="removeFromCart(this.id)" type="button" class="m-btn btn btn-default"><i
                        class="fa fa-minus"></i></button>
                    <button type="button" class="m-btn btn btn-default"> ${amount} </button>
                    <button id="product${pid}" onclick="addToCart(this.id)" type="button" class="m-btn btn btn-default"><i
                        class="fa fa-plus"></i></button>
                </div>
            </td>
            <td>
                <div class="price-wrap">
                    <var class="price">$${price}</var>
                </div>
                <!-- price-wrap .// -->
            </td>
            <td class="text-right">
                <button id="product${pid}" onclick="removeAllFromCart(this.id)" class="btn btn-outline-danger"> <i class="fa fa-trash"></i></button>
            </td>
        </tr>
    `;

    const getRequest = (url, params) => {
        return axios({
            method: 'get',
            url: `${url}`,
            params: params,
        });
    }

    const postRequest = (url, params) => {
        return axios({
            method: 'post',
            url: `${url}`,
            data: params,
        });
    }

    $(function () {
        //The passed argument has to be at least a empty object or a object with your desired options
        $("body").overlayScrollbars({});
        $("#items").height(552);
        $("#items").overlayScrollbars({
            overflowBehavior: {
                x: "hidden",
                y: "scroll"
            }
        });
        $("#cart").height(445);
        $("#cart").overlayScrollbars({});
    });


    $(document).ready(function () {
         getRequest("http://localhost:8080/api/products", "").then(resp => {
            const products = resp.data.obj;

            console.log(products.length)

            for (var i = 0; i < products.length; i++) {
                $("#itemrow").append(Item(products[i]));
            }
        });
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        renderCart(cart);
    });


    const Item = ({id, name, price}) => `
        <div class="col-md-3">
            <figure class="card card-product">
                <span class="badge-new"> NEW </span>
                <div class="img-wrap">
                    <img src="/images/placeholder.png" alt="">
                    <a class="btn-overlay" href="#"><i class="fa fa-search-plus"></i> Quick view</a>
                </div>
                <figcaption class="info-wrap">
                    <a href="#" class="title">${name}</a>
                    <div class="action-wrap">
                        <button class="btn btn-primary btn-sm float-right" id="product${id}"
                        onclick="addToCart(this.id)"> <i class="fa fa-cart-plus"></i> Add </button>
                        <div class="price-wrap h5">
                            <span class="price-new">$${price}</span>
                        </div> <!-- price-wrap.// -->
                    </div> <!-- action-wrap -->
                </figcaption>
            </figure> <!-- card // -->
        </div> <!-- col // -->
        `;
</script>


</body>

</html>